name: Swift Package Registry Sync

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  sync-to-registry:
    name: Sync Package to Swift Registry
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Get Tag and Version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          tag_name=${GITHUB_REF#refs/tags/}
          echo "tag=$tag_name" >> $GITHUB_OUTPUT
          echo "version=$tag_name" >> $GITHUB_OUTPUT
        else
          echo "tag=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "version=0.0.0" >> $GITHUB_OUTPUT
        fi
    
    - name: Print Package Information
      run: |
        echo "ðŸ“¦ Package: CashfreePG"
        echo "ðŸ“Œ Version: ${{ steps.version.outputs.version }}"
        echo "ðŸ·ï¸ Tag: ${{ steps.version.outputs.tag }}"
    
    - name: Validate Package.swift
      run: |
        echo "ðŸ” Validating Package.swift..."
        swift package dump-package > /dev/null
        echo "âœ… Package.swift is valid"
    
    - name: Resolve Dependencies
      run: |
        echo "ðŸ“¦ Resolving dependencies..."
        swift package resolve
        echo "âœ… Dependencies resolved"
    
    - name: Build Package
      run: |
        echo "ðŸ”¨ Validating Swift package..."
        
        # Check if package contains buildable targets
        has_buildable=$(swift package dump-package | python3 -c "
        import sys, json
        data = json.load(sys.stdin)
        buildable_targets = [t for t in data.get('targets', []) if t.get('type') != 'binary']
        print('true' if buildable_targets else 'false')
        ")
        
        if [ "$has_buildable" = "true" ]; then
          echo "ðŸ“¦ Found buildable targets, running swift build..."
          swift build
          echo "âœ… Package built successfully"
        else
          echo "ðŸ“¦ Package contains only binary targets (XCFrameworks)"
          echo "âœ… Binary package validation - no build required"
        fi
    
    - name: Run Tests
      run: |
        echo "ðŸ§ª Running package tests..."
        
        # Check if package has test targets
        has_tests=$(swift package dump-package | python3 -c "
        import sys, json
        data = json.load(sys.stdin)
        test_targets = [t for t in data.get('targets', []) if t.get('type') == 'test']
        print('true' if test_targets else 'false')
        ")
        
        if [ "$has_tests" = "true" ]; then
          swift test
          echo "âœ… All tests passed"
        else
          echo "â„¹ï¸ No test targets found in binary package"
          echo "âœ… Binary package - tests not applicable"
        fi
    
    - name: Validate XCFrameworks
      run: |
        echo "ðŸ” Validating XCFrameworks..."
        for framework in *.xcframework; do
          if [ -d "$framework" ]; then
            echo "ðŸ“± Validating $framework..."
            if [ -f "$framework/Info.plist" ]; then
              echo "âœ… $framework has valid Info.plist"
            else
              echo "âŒ $framework missing Info.plist"
              exit 1
            fi
          fi
        done
        echo "âœ… All XCFrameworks validated"
    
    - name: Remove Package Archive
      run: |
        echo "ï¿½ï¸ Cleaning up package archive..."
        rm -f "CashfreePG-${{ steps.version.outputs.version }}.tar.gz"
        echo "âœ… Archive removed"
    
    - name: Publish to Swift Package Registry
      uses: twodayslate/swift-package-registry@v0.0.2
      with:
        source: '.'
    
    - name: Summary
      run: |
        echo "## ðŸŽ‰ CashfreePG SDK ${{ steps.version.outputs.version }} Released" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Steps" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Package validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependencies resolved" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Binary package validation successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… XCFrameworks validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Published to Swift Package Registry" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Available via" >> $GITHUB_STEP_SUMMARY
        echo "- Swift Package Manager (GitHub)" >> $GITHUB_STEP_SUMMARY
        echo "- Swift Package Registry" >> $GITHUB_STEP_SUMMARY
        echo "- CocoaPods" >> $GITHUB_STEP_SUMMARY
